<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="application-name" content="Agility Contest's Serial Chronometer Web Console" />
    <meta name="copyright" content="Â© 2019 Juan Antonio Martinez" />
    <meta name="author" lang="en" content="Juan Antonio Martinez" />
    <title>Now Running Web console</title>
    <script src="jquery-2.2.4.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="jquery-chronometer.js" type="text/javascript" charset="utf-8"></script>
    <script src="countdown.js" type="text/javascript" charset="utf-8"></script>
    <script src="sprintf.js" type="text/javascript" charset="utf-8"></script>
    <script src="crono.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="toogle-switch.css" />
    <style type="text/css">
        .input_number {
            width:50px;
            display:inline-block;
            padding:10px 0px 10px 0px;
        }
        .chrono_fondo {
            border: 5px solid black;
            border-radius: 10px;
        }
        .title {
            color: white;
            text-align:right;
            font-style: italic;
            font-weight: bold;
        }
        .display {
            font-family: cmonospace monospace;
            text-align: center;
            font-weight: bold;
            font-size: 12.5vw;
        }
    </style>
    <script type="text/javascript">


        // used to store last command id parsed
        var lastID=0;
        var alive_timestamp=0;
        var start_timestamp=0;

        String.prototype.explode = function (separator, limit) {
            const array = this.split(separator);
            if (limit !== undefined && array.length >= limit)  {
                array.push(array.splice(limit - 1).join(separator));
            }
            return array;
        };
        /**
         * Replacement for toFixed, but trunk instead of round
         * @param {float} value Value to be parsed,
         * @param {int} numdecs Number of decimal numbers to be shown
         * no, cannot use sprintf library, as internally uses toFixed() rounding
         */
        function toFixedT(value,numdecs) {
            // first approach. may fail with some numbers due to internal handling of floating point
            // numbers in javascript: ie: toFixedT(4.27 , 2 ) return 4.26 due to js internal handling
            if (typeof(value)==="undefined") return "";
            if (value==null) return "";
            if (value==="") return "";
            if (isNaN(value)) return value;
            if (value<0) value=0; // PENDING should not happen. need to study
            var str="";
            switch (parseInt(numdecs)) {
                case 0: return parseInt(value);
                case 1: str= value.toString().match(/^\d+(?:\.\d{0,1})?/); break;
                case 2: str= value.toString().match(/^\d+(?:\.\d{0,2})?/); break;
                case 3: str= value.toString().match(/^\d+(?:\.\d{0,3})?/); break;
                case 4: str= value.toString().match(/^\d+(?:\.\d{0,4})?/); break;
                default: return value.toFixed(numdecs); // use default javascript routine
            }
            // now complete number of decimals reqired
            if (str=="0") str="0.00001"; // very, very, very stupid javascript
            if (str.toString().indexOf(".")<0) str=str+".00001";
            else str=str+"00001";
            var res=str.split(".");
            return res[0]+"."+res[1].substr(0,numdecs);
        }

        var c_llamada = new Countdown({
            seconds:15,  // number of seconds to count down
            onUpdateStatus: function(tsec){
                var dta=sprintf('%d.%d', Math.floor(tsec/10),tsec%10);
                $('#Clock').val(dta);
            }, // callback for each second
            onCounterEnd: function(){ /*empty*/ } // what about firing "start" ?
        });

        var c_reconocimiento = new Countdown({
            seconds: 60*parseInt($('#WalkTime').val()),
            onStart: function () { /*empty */ },
            onStop: function () { /*empty */ },
            onUpdateStatus: function(tsec){
                var sec=tsec/10; // remove tenths of seconds
                var time=sprintf('%02d:%02d', Math.floor(sec/60),sec%60);
                $('#Clock').val( time );
            }, // callback for each tenth of second
            onCounterEnd: function(){ /* empty */ }
        });

        // create a Chronometer instance
        $('#cronoauto').Chrono( {
            seconds_sel: '#chrono_timestamp',
            auto: false,
            interval: 50,
            showMode: 2,
            onBeforePause: function() { return true; },
            onBeforeResume: function() {  return true; },
            onUpdate: function(elapsed,running,paused) {
                $('#Clock').val(toFixedT(parseFloat(elapsed/1000.0),(running)?1:2));
                return true;
            }
        });

        function doLayout(dg,id,x,y,w,h) {
            var elem=$(id);
            elem.css('display','inline-block');
            elem.css('position','absolute');
            elem.css('float','left');
            // elem.css('padding','5px');
            elem.css('-webkit-box-sizing','border-box');
            elem.css('-moz-box-sizing','border-box');
            elem.css('box-sizing','border-box');
            elem.css('left',  ((25+x*100)/dg.cols)+'%');
            elem.css('top',   ((100+y*100)/dg.rows)+'%');
            elem.css('width', ((w*100)/dg.cols)+'%');
            elem.css('height',((h*100)/dg.rows)+'%');
            // elem.css('line-height',((h*100)/dg.rows)+'%');
            // elem.css('vertical-align','bottom');
        }

        function initialize() {
            start_ts=Date.now();
            $('#btn_turno').prop('checked',true);
            $('#sel_rec').val("0").prop('enabled',true);
            lastID=0;
            alive_timestamp=0;
            start_timestamp=0;
            c_reconocimiento.reset(420); // default. will change later
            c_llamada.reset(15);
            readData();
            setInterval(function() { readData(); },1000);
            var layout= {'rows':55,'cols':145};
            doLayout(layout,"#Logo",7,5,20,10);
            doLayout(layout,"#Copyright",35,3,107,3);
            doLayout(layout,"#Banner",35,5,107,5);
            doLayout(layout,"#MessageBox",35,2,60,7);
            doLayout(layout,"#fondo_clock",34,14,62,27);
            doLayout(layout,"#Clock",35,15,60,25);
            doLayout(layout,"#fondo_datos",99,14,43,27);
            doLayout(layout,"#FaltasLbl",103,17,10,5);
            doLayout(layout,"#Faltas",115,16,5,5);
            doLayout(layout,"#FaltasUp",122,16,8,5);
            doLayout(layout,"#FaltasDown",132,16,8,5);
            doLayout(layout,"#RehusesLbl",103,27,10,5);
            doLayout(layout,"#Rehuses",115,25,5,5);
            doLayout(layout,"#RehusesUp",122,25,8,5);
            doLayout(layout,"#RehusesDown",132,25,8,5);
            doLayout(layout,"#EliminadoLbl",103,36,10,5);
            doLayout(layout,"#Eliminado",115,34,5,5);
            doLayout(layout,"#EliminadoUp",122,34,8,5);
            doLayout(layout,"#EliminadoDown",132,34,8,5);
            doLayout(layout,"#fondo_info",4,26,27,15);
            doLayout(layout,"#RingLbl",8,29,10,5);
            doLayout(layout,"#Ring",19,28,10,5);
            doLayout(layout,"#TurnoLbl",8,35,10,5);
            doLayout(layout,"#Turno",19,34,10,5);
            doLayout(layout,"#fondo_buttons",4,44,138,7);
            doLayout(layout,"#ResetBtn",5,45,15,5);
            doLayout(layout,"#StartBtn" ,25,45,15,5);
            doLayout(layout,"#IntBtn",45,45,15,5);
            doLayout(layout,"#StopBtn",65,45,15,5);
            doLayout(layout,"#SalidaBtn",98,45,15,5);
            doLayout(layout,"#ReconocimientoBtn",118,45,15,5);
            doLayout(layout,"#WalkTime",134,45,7,5);
            $('#MessageBox').css("display","none");
        }

    </script>
</head>
<body onload="initialize();" style="background:blue">
<div id="cronoauto"><span id="chrono_StartStopFlag" style="display:none">Start</span></div>
<div style="width:100%">

    <form id="parameters" autocomplete="off">
        <!-- logotipo -->
    <label id="Logo" name="Logo" class="logo"><a target="info" href="/getInfo"><img src="/AgilityContest.png" alt="logo" width="100%"></a></label>
        <!-- titulo de cabecera -->
    <label id="Banner" class="title" for="Clock" class="title"><h2>AgilityContest Serial Chronometer Web Interface</h2></label>
        <!-- ventana del reloj -->
    <span class="chrono_fondo" style="background: red;"id="fondo_clock">&nbsp;</span>
    <a target="clock" href="/clock" >
        <input id="Clock" class="display" type="text" readonly="readonly" name="Clock" value="43:21">
    </a>
        <span class="chrono_fondo" id="MessageBox" style="display:none;text-align:center;vertical-align:middle;background: #f4e579"></span>
        <!-- ventana de faltas y rehuses -->
        <span class="chrono_fondo " id="fondo_datos" style="background: #87CEEB">&nbsp;</span>
    <label id="FaltasLbl" for="Faltas" class="data">Faltas:</label>
    <input id="Faltas"  class="data" type="text" readonly="readonly" name="F" value="Faltas">
    <input id="FaltasUp" class="data" type="button" name="FaltasUp" value="Flt+" onclick="falta(1)"/>
    <input id="FaltasDown"  class="data" type="button" name="FaltasDown" value="Flt-" onclick="falta(-1)">
    <label id="RehusesLbl" for="Rehuses" class="data">Rehuses:</label>
    <input id="Rehuses"  class="data" type="text" readonly="readonly" name="R" value="Rehuses">
    <input id="RehusesUp" class="data" type="button" name="RehusesUp" value="Reh+" onclick="rehuse(1);"/>
    <input id="RehusesDown"  class="data" type="button" name="RehusesDown" value="Reh-" onclick="rehuse(-1);">
    <label id="EliminadoLbl" for="Eliminado" class="data">Eliminado:</label>
    <input id="Eliminado"  class="data" type="text" readonly="readonly" name="F" value="Eliminado">
    <input id="EliminadoUp" class="data" type="button" name="EliminadoUp" value="El+" onclick="eliminado(1);"/>
    <input id="EliminadoDown"  class="data" type="button" name="EliminadoDown" value="El-" onclick="eliminado(-1);">

    <!-- ventana de turno y ring -->
        <span class="chrono_fondo " id="fondo_info" style="background: #87CEEB">&nbsp;</span>
    <label id="TurnoLbl" for="Turno" class="data">En pista:</label>
    <input id="Turno"  class="data" type="text" readonly="readonly" name="Turno" value="Turno">
    <label id="RingLbl" for="Ring" class="data">Ring:</label>
    <input id="Ring"  class="data" type="text" readonly="readonly" name="Ring" value="Ring">

    <!-- botonera de abajo -->
        <span class="chrono_fondo" id="fondo_buttons" style="background:#a6ff7c">&nbsp;</span>
    <input id="ResetBtn" class="data" type="button" name="Reset" value="Reset" onclick="c_reset(true);"/>
    <input id="StartBtn" class="data" type="button" name="Start" value="Start" onclick="start_run(0,true);"/>
    <input id="IntBtn" class="data" type="button" name="Intermediate" value="T. Int." onclick="int_run(0,true);"/>
    <input id="StopBtn" class="data" type="button" name="Stop" value="Stop" onclick="stop_run(0,true);"/>
    <input id="SalidaBtn" class="data" type="button" name="Salida" value="15 Secs." onclick="llamada(15,true);"/>
        <input id="ReconocimientoBtn" class="data" type="button" name="CourseWalk" value="CourseWalk" onclick="reconocimiento(420,true);"/>
        <input id="WalkTime" class="data" type="number" name="WalkTime" value="7" min="6" max="10" step="1"/>

    </form>
</div>
<span id="Copyright" style="color:white;width:100%;display:block;text-align:right;font-style:italic;font-size:10px"><br/>Copyright &copy; 2019 by JAMC para AgilityContest 3.9.1</span>
</body>
</html>
